<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slope Sentry Dashboard</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        
        .status-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        .card h2 { margin: 0; font-size: 2.5em; color: #555; }
        .card p { margin: 5px 0 0; color: #888; font-weight: bold; }
        
        /* Risk States Colors */
        .state-Low { color: #2ecc71; }
        .state-Moderate { color: #f1c40f; }
        .state-High { color: #e74c3c; animation: pulse 1s infinite alternate; }
        
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.7; } }

        .charts { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .chart-container { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        table { width: 100%; margin-top: 30px; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #333; color: white; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>⛰️ Slope Sentry</h1>
            <p>IoT Landslide Risk Monitoring System</p>
            <span id="connection-status" style="background: #2ecc71; color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8em;">System Online</span>
        </header>

        <!-- Real-time Status -->
        <div class="status-cards">
            <div class="card">
                <h2 id="risk-display">--%</h2>
                <p>Current Risk</p>
            </div>
            <div class="card">
                <h2 id="state-display">--</h2>
                <p>Risk State</p>
            </div>
            <div class="card">
                <h2 id="rain-display">--</h2>
                <p>Rain Value</p>
            </div>
            <div class="card">
                <h2 id="soil-display">--</h2>
                <p>Soil Moisture</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts">
            <div class="chart-container">
                <canvas id="sensorChart"></canvas>
            </div>
        </div>

        <!-- History Log -->
        <h3>Recent Activity Log</h3>
        <table id="history-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Risk State</th>
                    <th>Risk %</th>
                    <th>Rain</th>
                    <th>Soil</th>
                    <th>Tilt</th>
                </tr>
            </thead>
            <tbody>
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>

    <script>
        const ctx = document.getElementById('sensorChart').getContext('2d');
        const sensorChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Rain', borderColor: '#3498db', data: [] },
                    { label: 'Soil Moisture', borderColor: '#27ae60', data: [] },
                    { label: 'Tilt', borderColor: '#e67e22', data: [] },
                    { label: 'Risk %', borderColor: '#e74c3c', borderDash: [5, 5], data: [] }
                ]
            },
            options: { responsive: true, interaction: { mode: 'index', intersect: false } }
        });

        async function fetchData() {
            try {
                // Get Latest Data for cards
                const latestRes = await fetch('/api/latest');
                const latest = await latestRes.json();

                if (latest.risk_score !== undefined) {
                    document.getElementById('risk-display').innerText = latest.risk_score + '%';
                    
                    const stateEl = document.getElementById('state-display');
                    stateEl.innerText = latest.risk_state;
                    stateEl.className = 'state-' + latest.risk_state; // Change color

                    document.getElementById('rain-display').innerText = latest.rain_value;
                    document.getElementById('soil-display').innerText = latest.soil_moisture;
                }

                // Get History for Chart
                const historyRes = await fetch('/api/history');
                const history = await historyRes.json();
                const reversedHistory = history.reverse(); // API sends latest first, chart needs oldest first

                // Update Chart
                sensorChart.data.labels = reversedHistory.map(d => d.timestamp.split(' ')[1]); // Time only
                sensorChart.data.datasets[0].data = reversedHistory.map(d => d.rain_value);
                sensorChart.data.datasets[1].data = reversedHistory.map(d => d.soil_moisture);
                sensorChart.data.datasets[2].data = reversedHistory.map(d => d.tilt_value);
                sensorChart.data.datasets[3].data = reversedHistory.map(d => d.risk_score);
                sensorChart.update();

                // Update Table
                const tableBody = document.querySelector('#history-table tbody');
                tableBody.innerHTML = '';
                history.slice(0, 10).forEach(row => { // Show last 10
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.timestamp}</td>
                        <td style="font-weight:bold" class="state-${row.risk_state}">${row.risk_state}</td>
                        <td>${row.risk_score}%</td>
                        <td>${row.rain_value}</td>
                        <td>${row.soil_moisture}</td>
                        <td>${row.tilt_value}</td>
                    `;
                    tableBody.appendChild(tr);
                });

            } catch (err) {
                console.error("Error fetching data:", err);
                document.getElementById('connection-status').innerText = "OFFLINE";
                document.getElementById('connection-status').style.background = "#e74c3c";
            }
        }

        // Refresh every 2 seconds
        setInterval(fetchData, 2000);
        fetchData();
    </script>
</body>
</html>
